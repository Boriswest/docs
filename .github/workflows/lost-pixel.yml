name: LostPixel

on: [pull_request]

jobs:
  gatsby-for-lostpixel:
    name: Lost Pixel screenshots via Gatsby build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Get list of all changed files
        id: files
        uses: Ana06/get-changed-files@v1.2 # it's a fork of jitterbit/get-changed-files@v1 which works better with pull requests
      - name: Extract links
        id: links
        run: |
          # Declare an array to store the links
          declare -a linksArray
          
          for changed_file in ${{ steps.files.outputs.all }}; do
            if [[ $changed_file == content/* ]]; then         
              cleaned_file=$(echo "$changed_file" | sed -E 's:content/:/:g' | sed -E 's:/index.mdx::g' | sed -e 's/.mdx//g' | sed -E 's:/[0-9]+-:/:g')
              # TODO special case for images and similar non .mdx files
          
              # Output inside the action
              echo "- /docs$cleaned_file"
          
              # Add the link to the array
              link="/docs$cleaned_file"
              linksArray+=("$link")
            fi
          done
          
          # Join the array elements with a delimiter and set as output
          linksOutput=$(IFS=, ; echo "${linksArray[*]}")
          echo "::set-output name=links::$linksOutput"
          
      - name: Output relevant files
        run: |
          # Get the links string from the previous step and replace commas with spaces
          linksString="${{ steps.links.outputs.links }}"
          linksArray=($(echo "$linksString" | sed 's/,/ /g'))
          
          # Print the array contents
          for link in "${linksArray[@]}"; do
            echo "$link"
          done
      
      - uses: actions/setup-node@v2
        with:
          cache: 'npm'
          node-version: '14'
      - run: npm ci
      - name: Caching Gatsby
        id: gatsby-cache-build
        uses: actions/cache@v2
        with:
          path: |
            public
            .cache
          key: ${{ runner.os }}-gatsby-build-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-gatsby-build-
      - name: Build Gatsby app
        run: npx gatsby build --prefix-paths
        env:
          GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES: true
          CI: true

      - name: Run Gatsby app
        run: npx gatsby serve --host 172.17.0.1 &

      - name: Lost Pixel
        uses: lost-pixel/lost-pixel@feature/file-api-url
        env:
          LOST_PIXEL_API_KEY: ${{ secrets.LOST_PIXEL_API_KEY }}
